<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>GlslCanvas</title>
  <script type="text/javascript"
    src="dist/GlslCanvas.js"></script>
  <style>
    body {
      background: #101515;
    }

    #glslCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <canvas id="glslCanvas" data-fragment-url="shaders/Genetic_image_drawing_v2.frag" width="600" height="900"
    data-textures="data/DSC02066.JPG"></canvas>
  <div id="controls" style="position: absolute; left: 20px; top: 20px; color: #eee; font-family: Arial, sans-serif;">
    <label for="aperture">光圈 (Aperture)：</label>
    <input id="aperture" type="range" min="0" max="1" step="0.01" value="0.5" style="vertical-align: middle;">
    <span id="apertureVal">0.50</span>
    <button id="reset" style="margin-left:12px; padding:4px 8px;">重新拍照 (Reset)</button>
    <button id="pauseBtn" style="margin-left:8px; padding:4px 8px;">暫停並儲存 (Pause & Save)</button>
  </div>
</body>
<script>
  var canvas = document.getElementById("glslCanvas");
  var sandbox = new GlslCanvas(canvas);
  var texCounter = 0;
  var sandbox_content = "";
  var sandbox_title = "";
  var sandbox_author = "";
  var sandbox_thumbnail = "";

  // Aperture slider -> 傳值給 shader 的 uniform `u_aperture`
  (function(){
    var aperture = document.getElementById('aperture');
    var apertureVal = document.getElementById('apertureVal');
    // Set initial uniform (some GlslCanvas builds expect setUniform to be called after creation)
    if(sandbox && typeof sandbox.setUniform === 'function'){
      sandbox.setUniform('u_aperture', parseFloat(aperture.value));
    }

    aperture.addEventListener('input', function(e){
      var v = parseFloat(e.target.value);
      apertureVal.textContent = v.toFixed(2);
      if(sandbox && typeof sandbox.setUniform === 'function'){
        sandbox.setUniform('u_aperture', v);
      }
    });
    // Reset button: 優先使用 sandbox.load() 重新載入 fragment 以清空累積 buffer，若無該 method 則 fallback reload page
    var resetBtn = document.getElementById('reset');
    resetBtn.addEventListener('click', function(){
      var fragUrl = canvas.getAttribute('data-fragment-url');
      if(!fragUrl){
        location.reload();
        return;
      }
      // 使用 fetch 讀取 fragment 原始內容，再呼叫 sandbox.load(source)
      fetch(fragUrl).then(function(resp){
        if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
        return resp.text();
      }).then(function(src){
        if(sandbox && typeof sandbox.load === 'function'){
          sandbox.load(src);
        } else {
          location.reload();
        }
      }).catch(function(err){
        console.error('Reset fetch/load failed, reloading page', err);
        location.reload();
      });
    // Pause & Save 按鈕：暫停 shader 的更新，並將目前 canvas 匯出為 PNG
    var pauseBtn = document.getElementById('pauseBtn');
    var isPaused = false;
    pauseBtn.addEventListener('click', function(){
      if(!sandbox) return;
      if(!isPaused){
        // pause 更新
        if(typeof sandbox.pause === 'function') sandbox.pause();
        isPaused = true;
        pauseBtn.textContent = '繼續 (Resume)';
        // 強制一次 render 的成果已在畫面上，直接匯出 canvas
        try{
          // 儲存為 PNG 檔案
          var dataURL = canvas.toDataURL('image/png');
          var a = document.createElement('a');
          a.href = dataURL;
          var now = new Date();
          var filename = 'glsl_capture_' + now.getFullYear() + ('0'+(now.getMonth()+1)).slice(-2) + ('0'+now.getDate()).slice(-2) + '_' + now.getHours() + ('0'+now.getMinutes()).slice(-2) + (''+now.getSeconds()).padStart(2,'0') + '.png';
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }catch(e){
          console.error('Export failed', e);
        }
      } else {
        // resume
        if(typeof sandbox.play === 'function') sandbox.play();
        isPaused = false;
        pauseBtn.textContent = '暫停並儲存 (Pause & Save)';
      }
    });
    });
  })();
</script>

</html>