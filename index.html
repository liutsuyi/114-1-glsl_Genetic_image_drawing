<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>GlslCanvas</title>
  <script type="text/javascript"
    src="dist/GlslCanvas.js"></script>
  <style>
    body {
      background: #101515;
    }

    #glslCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <canvas id="glslCanvas" data-fragment-url="shaders/Genetic_image_drawing_v2.frag" width="600" height="900" data-textures="data/DSC02066.JPG,data/DSC02066_night.png"></canvas>

  <div id="controls" class="controls">
    <div style="font-weight:600; margin-bottom:8px;">Controls</div>
    <label for="aperture">光圈 (Aperture)</label>
    <div style="display:flex; align-items:center; gap:8px; margin:6px 0 12px 0;">
      <!-- 離散 f-stop 刻度模擬相機操作：index 0..8 對應 f/1.4..f/22 -->
      <input id="aperture" type="range" min="0" max="8" step="1" value="4">
      <span id="apertureVal">f/5.6</span>
    </div>
    <label for="hybrid">Hybrid 比例 (白天 ↔ 夜景)</label>
    <div style="display:flex; align-items:center; gap:8px; margin:6px 0 12px 0;">
      <input id="hybrid" type="range" min="0" max="1" step="0.01" value="0.0">
      <span id="hybridVal">0%</span>
    </div>
    <div style="margin-bottom:8px;">
      <button id="reset" class="ctrl-btn">重製 (Reset)</button>
    </div>
    <!-- Pause 功能已移除 -->
  </div>
</body>
<script>
  var canvas = document.getElementById("glslCanvas");
  var sandbox = new GlslCanvas(canvas);
  var texCounter = 0;
  var sandbox_content = "";
  var sandbox_title = "";
  var sandbox_author = "";
  var sandbox_thumbnail = "";

  // Aperture slider -> 傳值給 shader 的 uniform `u_aperture`
  (function(){
    var aperture = document.getElementById('aperture');
    var apertureVal = document.getElementById('apertureVal');
    // f-stop 刻度陣列（模擬相機刻度）
    var fStops = [1.4, 2.0, 2.8, 4.0, 5.6, 8.0, 11.0, 16.0, 22.0];
    var initialIndex = parseInt(aperture.value, 10) || 4;
    // 初始化顯示為 f/5.6（index 4）或 input 的 value
    apertureVal.textContent = 'f/' + fStops[initialIndex];
    // Set initial uniform mapping index -> 0..1 (保留 shader 內使用的 0..1 u_aperture)
    if(sandbox && typeof sandbox.setUniform === 'function'){
      sandbox.setUniform('u_aperture', initialIndex / (fStops.length - 1));
    }

    aperture.addEventListener('input', function(e){
      var idx = parseInt(e.target.value, 10);
      var display = 'f/' + fStops[idx];
      apertureVal.textContent = display;
      // 把離散刻度 index 映射到 0..1 傳給 shader，實際 shader 行為不需真實 f 值
      var mapped = idx / (fStops.length - 1);
      if(sandbox && typeof sandbox.setUniform === 'function'){
        sandbox.setUniform('u_aperture', mapped);
      }
    });

    // 初始化 hybrid slider 顯示與 shader uniform
    var hybrid = document.getElementById('hybrid');
    var hybridVal = document.getElementById('hybridVal');
    hybridVal.textContent = Math.round(parseFloat(hybrid.value) * 100) + '%';
    if(sandbox && typeof sandbox.setUniform === 'function'){
      sandbox.setUniform('u_hybridMix', parseFloat(hybrid.value));
    }
    // Hybrid slider 監聽器：更新顯示並傳入 shader
    hybrid.addEventListener('input', function(e){
      var v = parseFloat(e.target.value);
      hybridVal.textContent = Math.round(v * 100) + '%';
      if(sandbox && typeof sandbox.setUniform === 'function'){
        sandbox.setUniform('u_hybridMix', v);
      }
    });

    // Reset button: 優先使用 sandbox.load() 重新載入 fragment 以清空累積 buffer，若無該 method 則 fallback reload page
    var resetBtn = document.getElementById('reset');
    resetBtn.addEventListener('click', function(){
      var fragUrl = canvas.getAttribute('data-fragment-url');
      if(!fragUrl){
        location.reload();
        return;
      }
      // 使用 fetch 讀取 fragment 原始內容，再呼叫 sandbox.load(source)
      fetch(fragUrl).then(function(resp){
        if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
        return resp.text();
      }).then(function(src){
        if(sandbox && typeof sandbox.load === 'function'){
          sandbox.load(src);
        } else {
          location.reload();
        }
      }).catch(function(err){
        console.error('Reset fetch/load failed, reloading page', err);
        location.reload();
      });
    });

    // Pause 功能已移除，保留 IIFE 結尾
  })();

  // 送滑鼠座標到 shader（兼容沒有自動綁定的 GlslCanvas），並做 flash 淡入/淡出
  (function(){
    var flash = 0.0;            // 當前強度
    var targetFlash = 0.0;      // 目標強度

    function sendMouse(e){
      var rect = canvas.getBoundingClientRect();
      var x = e.clientX - rect.left;
      var y = e.clientY - rect.top;
      // 將 client coords 轉換為 canvas 像素座標（處理 CSS 縮放）
      var canvasX = x * (canvas.width / rect.width);
      var canvasY = y * (canvas.height / rect.height);
      if(sandbox && typeof sandbox.setUniform === 'function'){
        sandbox.setUniform('u_mouse', [canvasX, canvasY]);
      }
      targetFlash = 1.0;
    }

    function clearMouse(){
      if(sandbox && typeof sandbox.setUniform === 'function'){
        // 清除 mouse（設定為 0,0）
        sandbox.setUniform('u_mouse', [0.0, 0.0]);
      }
      targetFlash = 0.0;
    }

    canvas.addEventListener('mousemove', sendMouse);
    canvas.addEventListener('touchmove', function(ev){ ev.preventDefault(); var t = ev.touches[0]; sendMouse(t); }, {passive:false});
    canvas.addEventListener('mouseleave', clearMouse);
    canvas.addEventListener('touchend', clearMouse);

    // 初始化 shader 的 u_flash
    if(sandbox && typeof sandbox.setUniform === 'function') sandbox.setUniform('u_flash', 0.0);

    // RAF loop：平滑地把 flash 逼近 targetFlash
    (function animate(){
      var k = 0.16; // 收斂速度
      flash += (targetFlash - flash) * k;
      if(sandbox && typeof sandbox.setUniform === 'function') sandbox.setUniform('u_flash', flash);
      requestAnimationFrame(animate);
    })();
  })();
</script>

<style>
  /* 控制面板樣式（左側固定、半透明背景） */
  .controls {
    position: fixed;
    left: 12px;
    top: 20px;
    width: 220px;
    padding: 12px;
    color: #eee;
    font-family: Arial, sans-serif;
    background: rgba(8,12,14,0.65);
    border-radius: 8px;
    z-index: 40;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  /* 將畫布恢復為原本置中顯示，避免被裁切 */
  #glslCanvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }
  .ctrl-btn{ padding:6px 8px; background:#1f6; border: none; border-radius:4px; cursor:pointer;}
</style>
</style>

</html>