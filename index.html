<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>GlslCanvas</title>
  <script type="text/javascript"
    src="dist/GlslCanvas.js"></script>
  <style>
    body {
      background: #101515;
    }

    #glslCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <canvas id="glslCanvas" data-fragment-url="shaders/Genetic_image_drawing_v2.frag" width="600" height="900" data-textures="data/DSC02066.JPG"></canvas>

  <div id="controls" class="controls">
    <div style="font-weight:600; margin-bottom:8px;">Controls</div>
    <label for="aperture">光圈 (Aperture)</label>
    <div style="display:flex; align-items:center; gap:8px; margin:6px 0 12px 0;">
      <input id="aperture" type="range" min="0" max="1" step="0.01" value="0.5">
      <span id="apertureVal">0.50</span>
    </div>
    <div style="margin-bottom:8px;">
      <button id="reset" class="ctrl-btn">重新拍照 (Reset)</button>
    </div>
    <div>
      <button id="pauseBtn" class="ctrl-btn">暫停 (Pause)</button>
    </div>
  </div>
</body>
<script>
  var canvas = document.getElementById("glslCanvas");
  var sandbox = new GlslCanvas(canvas);
  var texCounter = 0;
  var sandbox_content = "";
  var sandbox_title = "";
  var sandbox_author = "";
  var sandbox_thumbnail = "";

  // Aperture slider -> 傳值給 shader 的 uniform `u_aperture`
  (function(){
    var aperture = document.getElementById('aperture');
    var apertureVal = document.getElementById('apertureVal');
    // Set initial uniform (some GlslCanvas builds expect setUniform to be called after creation)
    if(sandbox && typeof sandbox.setUniform === 'function'){
      sandbox.setUniform('u_aperture', parseFloat(aperture.value));
    }

    aperture.addEventListener('input', function(e){
      var v = parseFloat(e.target.value);
      apertureVal.textContent = v.toFixed(2);
      if(sandbox && typeof sandbox.setUniform === 'function'){
        sandbox.setUniform('u_aperture', v);
      }
    });

    // Reset button: 優先使用 sandbox.load() 重新載入 fragment 以清空累積 buffer，若無該 method 則 fallback reload page
    var resetBtn = document.getElementById('reset');
    resetBtn.addEventListener('click', function(){
      var fragUrl = canvas.getAttribute('data-fragment-url');
      if(!fragUrl){
        location.reload();
        return;
      }
      // 使用 fetch 讀取 fragment 原始內容，再呼叫 sandbox.load(source)
      fetch(fragUrl).then(function(resp){
        if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
        return resp.text();
      }).then(function(src){
        if(sandbox && typeof sandbox.load === 'function'){
          sandbox.load(src);
        } else {
          location.reload();
        }
      }).catch(function(err){
        console.error('Reset fetch/load failed, reloading page', err);
        location.reload();
      });
    });

    // Pause 按鈕：僅暫停/繼續演算（取消自動下載）
    var pauseBtn = document.getElementById('pauseBtn');
    var isPaused = false;
    pauseBtn.addEventListener('click', function(){
      if(!sandbox) return;
      if(!isPaused){
        if(typeof sandbox.pause === 'function') sandbox.pause();
        isPaused = true;
        pauseBtn.textContent = '繼續 (Resume)';
      } else {
        if(typeof sandbox.play === 'function') sandbox.play();
        isPaused = false;
        pauseBtn.textContent = '暫停 (Pause)';
      }
    });
  })();
</script>

<style>
  /* 控制面板樣式（左側固定、半透明背景） */
  .controls {
    position: fixed;
    left: 12px;
    top: 20px;
    width: 220px;
    padding: 12px;
    color: #eee;
    font-family: Arial, sans-serif;
    background: rgba(8,12,14,0.65);
    border-radius: 8px;
    z-index: 40;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  /* 將畫布恢復為原本置中顯示，避免被裁切 */
  #glslCanvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }
  .ctrl-btn{ padding:6px 8px; background:#1f6; border: none; border-radius:4px; cursor:pointer;}
</style>
</script>

</html>